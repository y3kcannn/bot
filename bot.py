import os
import discord
from discord.ext import commands
import requests
import json
import asyncio
from datetime import datetime

# Bot Configuration
TOKEN = os.getenv("TOKEN")
GUILD_ID = 1234567890  # Your Discord server ID
ADMIN_ROLE = os.getenv("ADMIN_ROLE", "Admin")
API_URL = os.getenv("API_URL")
API_TOKEN = os.getenv("API_TOKEN")

# Bot setup
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix='!', intents=intents)

# VarsayÄ±lan help komutunu kaldÄ±r
bot.remove_command('help')

def make_api_request(action, data=None):
    """Make API request to the server"""
    try:
        url = f"{API_URL}?api=1&token={API_TOKEN}&action={action}"
        print(f"ğŸ”— API Request: {url}")  # Debug line
        
        if data:
            print(f"ğŸ“¤ POST Data: {data}")  # Debug line
            response = requests.post(url, data=data, timeout=10)
        else:
            response = requests.get(url, timeout=10)
        
        print(f"ğŸ“¥ API Response: {response.text}")  # Debug line
        return response.json()
    except Exception as e:
        print(f"âŒ API Error: {str(e)}")  # Debug line
        return {"error": f"API request failed: {str(e)}"}

def has_admin_role():
    """Check if user has admin role"""
    def predicate(ctx):
        return any(role.name == ADMIN_ROLE for role in ctx.author.roles)
    return commands.check(predicate)

def create_embed(title, description=None, color=0x00ff00):
    """Create a beautiful embed with bot profile"""
    embed = discord.Embed(
        title=title,
        description=description,
        color=color,
        timestamp=datetime.utcnow()
    )
    embed.set_footer(
        text="Keylogin Management System",
        icon_url=bot.user.avatar.url if bot.user.avatar else None
    )
    embed.set_thumbnail(url=bot.user.avatar.url if bot.user.avatar else None)
    return embed

async def auto_delete_message(message, delay=6):
    """Auto delete message after specified delay"""
    await asyncio.sleep(delay)
    try:
        await message.delete()
    except:
        pass

@bot.event
async def on_ready():
    print(f'ğŸš€ {bot.user} is online and ready!')
    print(f'ğŸ“Š Connected to {len(bot.guilds)} servers')
    
    # Set bot status
    await bot.change_presence(
        status=discord.Status.online,
        activity=discord.Game(name="ğŸ” Keylogin Management")
    )

@bot.command(name='genkey')
@has_admin_role()
async def generate_key(ctx):
    """Generate a new license key"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    # Create loading embed
    loading_embed = create_embed(
        "ğŸ”„ Key OluÅŸturuluyor...",
        "LÃ¼tfen bekleyin, yeni lisans anahtarÄ± oluÅŸturuluyor.",
        0xffff00
    )
    msg = await ctx.send(embed=loading_embed)
    
    # Generate key via API
    result = make_api_request('generate-key')
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Hata OluÅŸtu",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Success embed
    success_embed = create_embed(
        "âœ… Key BaÅŸarÄ±yla OluÅŸturuldu",
        f"**ğŸ”‘ Yeni Key:** `{result['key']}`\n**ğŸ“… OluÅŸturulma:** {result['created']}\n**ğŸ‘¤ OluÅŸturan:** {ctx.author.mention}",
        0x00ff00
    )
    success_embed.add_field(
        name="ğŸ“‹ Bilgi", 
        value="Bu key'i gÃ¼venli bir yerde saklayÄ±n!", 
        inline=False
    )
    msg = await ctx.send(embed=success_embed)
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))
    
    # Log to console
    print(f"ğŸ”‘ Key generated by {ctx.author}: {result['key']}")

@bot.command(name='ban')
@has_admin_role()
async def ban_user(ctx, username=None, ip=None):
    """Ban a user by username and/or IP"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    if not username and not ip:
        error_embed = create_embed(
            "âŒ HatalÄ± KullanÄ±m",
            "**KullanÄ±m:** `!ban <kullanÄ±cÄ±_adÄ±> [ip]`\n**Ã–rnek:** `!ban TestUser 192.168.1.1`",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    ban_data = {}
    if username:
        ban_data['username'] = username
    if ip:
        ban_data['ip'] = ip
    
    # Create loading embed
    loading_embed = create_embed(
        "ğŸ”„ KullanÄ±cÄ± BanlanÄ±yor...",
        f"**ğŸ‘¤ KullanÄ±cÄ±:** {username or 'Belirtilmedi'}\n**ğŸŒ IP:** {ip or 'Belirtilmedi'}",
        0xffff00
    )
    msg = await ctx.send(embed=loading_embed)
    
    # Ban via API
    result = make_api_request('ban-user', ban_data)
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Ban HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Success embed
    success_embed = create_embed(
        "ğŸš« KullanÄ±cÄ± BaÅŸarÄ±yla BanlandÄ±",
        f"**ğŸ‘¤ KullanÄ±cÄ±:** `{username or 'Belirtilmedi'}`\n**ğŸŒ IP:** `{ip or 'Belirtilmedi'}`\n**ğŸ‘® Banleyen:** {ctx.author.mention}",
        0xff6600
    )
    success_embed.add_field(
        name="âš ï¸ UyarÄ±", 
        value="Bu kullanÄ±cÄ± artÄ±k sisteme eriÅŸemeyecek!", 
        inline=False
    )
    msg = await ctx.send(embed=success_embed)
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))
    
    # Log to console
    print(f"ğŸ”¨ User banned by {ctx.author}: {username} / {ip}")

@bot.command(name='checkban')
@has_admin_role()
async def check_ban(ctx, username=None, ip=None):
    """Check if a user is banned"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    if not username and not ip:
        error_embed = create_embed(
            "âŒ HatalÄ± KullanÄ±m",
            "**KullanÄ±m:** `!checkban <kullanÄ±cÄ±_adÄ±> [ip]`\n**Ã–rnek:** `!checkban TestUser 192.168.1.1`",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Prepare check data
    check_data = {}
    if username:
        check_data['username'] = username
    if ip:
        check_data['ip'] = ip
    
    # Check via API
    result = make_api_request('check-ban', check_data)
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Kontrol HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Display result
    if result.get('banned'):
        banned_embed = create_embed(
            "ğŸš« KULLANICI BANLI",
            f"**ğŸ‘¤ KullanÄ±cÄ±:** `{username or 'Belirtilmedi'}`\n**ğŸŒ IP:** `{ip or 'Belirtilmedi'}`\n**ğŸ” Kontrol Eden:** {ctx.author.mention}",
            0xff0000
        )
        banned_embed.add_field(
            name="ğŸ“Š Durum", 
            value="Bu kullanÄ±cÄ± sistemden banlanmÄ±ÅŸ!", 
            inline=False
        )
    else:
        clean_embed = create_embed(
            "âœ… KULLANICI TEMÄ°Z",
            f"**ğŸ‘¤ KullanÄ±cÄ±:** `{username or 'Belirtilmedi'}`\n**ğŸŒ IP:** `{ip or 'Belirtilmedi'}`\n**ğŸ” Kontrol Eden:** {ctx.author.mention}",
            0x00ff00
        )
        clean_embed.add_field(
            name="ğŸ“Š Durum", 
            value="Bu kullanÄ±cÄ± banlanmamÄ±ÅŸ ve sisteme eriÅŸebilir.", 
            inline=False
        )
    
    msg = await ctx.send(embed=banned_embed if result.get('banned') else clean_embed)
    asyncio.create_task(auto_delete_message(msg))

@bot.command(name='stats')
@has_admin_role()
async def show_stats(ctx):
    """Show system statistics"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    result = make_api_request('stats')
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Ä°statistik HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    stats_embed = create_embed(
        "ğŸ“Š Sistem Ä°statistikleri",
        f"**ğŸ” Talep Eden:** {ctx.author.mention}\n**â° GÃ¼ncelleme:** <t:{int(__import__('time').time())}:R>",
        0x0099ff
    )
    
    # Ana istatistikler - Ä°ki sÃ¼tunlu
    stats_embed.add_field(
        name="ğŸ”‘ Lisans Durumu",
        value=f"```yaml\nToplam Keys : {result['total_keys']:>3}\nKullanÄ±lmÄ±ÅŸ : {result['used_keys']:>3}\nMevcut     : {result['available_keys']:>3}```",
        inline=True
    )
    
    stats_embed.add_field(
        name="ğŸš« GÃ¼venlik Durumu", 
        value=f"```yaml\nBanli User : {result['banned_users']:>3}\nBanli IP   : {result['banned_ips']:>3}\nToplam Ban : {result['banned_users'] + result['banned_ips']:>3}```",
        inline=True
    )
    
    # BoÅŸ alan
    stats_embed.add_field(name="\u200b", value="\u200b", inline=False)
    
    # Aktivite istatistikleri - Tek sÃ¼tun
    activity_percentage = min(100, (result['total_access_attempts'] / max(1, result['total_keys'])) * 100) if result['total_keys'] > 0 else 0
    key_usage_percentage = (result['used_keys'] / max(1, result['total_keys'])) * 100 if result['total_keys'] > 0 else 0
    
    stats_embed.add_field(
        name="ğŸ“ˆ Aktivite Analizi",
        value=f"""
```yaml
EriÅŸim Denemeleri    : {result['total_access_attempts']:>5}
Key KullanÄ±m OranÄ±   : %{key_usage_percentage:.1f}
Sistem Aktivitesi    : %{activity_percentage:.1f}
GÃ¼venlik Seviyesi    : {'ğŸŸ¢ YÃ¼ksek' if result['banned_users'] + result['banned_ips'] > 0 else 'ğŸŸ¡ Normal'}
```""",
        inline=False
    )
    
    # Durum gÃ¶stergeleri - Ä°ki sÃ¼tunlu
    stats_embed.add_field(
        name="ğŸ¯ Sistem Durumu",
        value="```\nğŸŸ¢ API     : Aktif\nğŸŸ¢ Database: Ã‡alÄ±ÅŸÄ±yor\nğŸŸ¢ GÃ¼venlik: Aktif```",
        inline=True
    )
    
    stats_embed.add_field(
        name="ğŸ”„ Son GÃ¼ncelleme",
        value="```\nğŸ“Š Stats  : Åimdi\nğŸ”„ Realtime: Aktif\nâš¡ HÄ±z     : Optimal```",
        inline=True
    )
    
    msg = await ctx.send(embed=stats_embed)
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

@bot.command(name='keys')
@has_admin_role()
async def list_keys(ctx):
    """List all license keys"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    result = make_api_request('list-keys')
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Key Listeleme HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    keys = result.get('keys', {})
    
    if not keys:
        empty_embed = create_embed(
            "ğŸ“ Key Listesi",
            "**HenÃ¼z oluÅŸturulmuÅŸ key bulunamadÄ±.**\n`!genkey` komutuyla yeni key oluÅŸturabilirsiniz.",
            0xffff00
        )
        msg = await ctx.send(embed=empty_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    keys_embed = create_embed(
        "ğŸ”‘ Key Listesi",
        f"**ğŸ“‹ Toplam {len(keys)} key bulundu**\n**ğŸ” Talep Eden:** {ctx.author.mention}",
        0x9932cc
    )
    
    key_list = ""
    for i, (key, data) in enumerate(list(keys.items())[:10], 1):
        status = "ğŸŸ¢ KULLANILMADI" if not data['used'] else "ğŸ”´ KULLANILDI"
        username = data.get('username', '-')
        key_list += f"**{i}.** `{key}`\n   {status} â€¢ {username}\n\n"
    
    if key_list:
        keys_embed.add_field(
            name="ğŸ“‹ Key DetaylarÄ± (Ä°lk 10)",
            value=key_list,
            inline=False
        )
    
    if len(keys) > 10:
        keys_embed.add_field(
            name="â„¹ï¸ Bilgi",
            value=f"Sadece ilk 10 key gÃ¶steriliyor. Toplam: {len(keys)} key",
            inline=False
        )
    
    msg = await ctx.send(embed=keys_embed)
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

@bot.command(name='banned')
@has_admin_role()
async def list_banned(ctx):
    """List all banned users"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    result = make_api_request('list-banned')
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Ban Listeleme HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    banned = result.get('banned', {'usernames': [], 'ips': []})
    
    banned_embed = create_embed(
        "ğŸš« Banli KullanÄ±cÄ± Listesi",
        f"**ğŸ” Talep Eden:** {ctx.author.mention}",
        0xff4444
    )
    
    if banned['usernames']:
        usernames_text = "\n".join([f"â€¢ `{user}`" for user in banned['usernames']])
        banned_embed.add_field(
            name=f"ğŸ‘¤ Banli KullanÄ±cÄ±lar ({len(banned['usernames'])})",
            value=usernames_text,
            inline=False
        )
    
    if banned['ips']:
        ips_text = "\n".join([f"â€¢ `{ip}`" for ip in banned['ips']])
        banned_embed.add_field(
            name=f"ğŸŒ Banli IP'ler ({len(banned['ips'])})",
            value=ips_text,
            inline=False
        )
    
    if not banned['usernames'] and not banned['ips']:
        banned_embed.add_field(
            name="ğŸ“‹ Durum",
            value="HenÃ¼z banlanmÄ±ÅŸ kullanÄ±cÄ± bulunmuyor.",
            inline=False
        )
    
    msg = await ctx.send(embed=banned_embed)
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

@bot.command(name='unban')
@has_admin_role()
async def unban_user(ctx, username=None, ip=None):
    """Unban a user by username and/or IP"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    if not username and not ip:
        error_embed = create_embed(
            "âŒ HatalÄ± KullanÄ±m",
            "**KullanÄ±m:** `!unban <kullanÄ±cÄ±_adÄ±> [ip]`\n**Ã–rnek:** `!unban TestUser 192.168.1.1`",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    unban_data = {}
    if username:
        unban_data['username'] = username
    if ip:
        unban_data['ip'] = ip
    
    # Create loading embed
    loading_embed = create_embed(
        "ğŸ”„ KullanÄ±cÄ± Ban KaldÄ±rÄ±lÄ±yor...",
        f"**ğŸ‘¤ KullanÄ±cÄ±:** {username or 'Belirtilmedi'}\n**ğŸŒ IP:** {ip or 'Belirtilmedi'}",
        0xffff00
    )
    msg = await ctx.send(embed=loading_embed)
    
    # Unban via API
    result = make_api_request('unban-user', unban_data)
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Unban HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Success embed
    success_embed = create_embed(
        "âœ… KullanÄ±cÄ± Ban'Ä± KaldÄ±rÄ±ldÄ±",
        f"**ğŸ‘¤ KullanÄ±cÄ±:** `{username or 'Belirtilmedi'}`\n**ğŸŒ IP:** `{ip or 'Belirtilmedi'}`\n**ğŸ‘® Ä°ÅŸlemi Yapan:** {ctx.author.mention}",
        0x00ff00
    )
    success_embed.add_field(
        name="âœ… Bilgi", 
        value="Bu kullanÄ±cÄ± artÄ±k sisteme tekrar eriÅŸebilecek!", 
        inline=False
    )
    msg = await ctx.send(embed=success_embed)
    
    # Log to console
    print(f"âœ… User unbanned by {ctx.author}: {username} / {ip}")
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

@bot.command(name='cleanup')
@has_admin_role()
async def cleanup_keys(ctx):
    """SÃ¼resi dolmuÅŸ keyleri temizler (30 dakika)"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    # Create loading embed
    loading_embed = create_embed(
        "ğŸ§¹ Key Temizleme Ä°ÅŸlemi...",
        "**â³ SÃ¼resi dolmuÅŸ keyler kontrol ediliyor...**",
        0xffff00
    )
    msg = await ctx.send(embed=loading_embed)
    
    # Cleanup via API
    result = make_api_request('cleanup-keys')
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Temizleme HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Success embed
    success_embed = create_embed(
        "ğŸ§¹ Key Temizleme TamamlandÄ±",
        f"**ğŸ“ Durum:** {result.get('message', 'Temizleme iÅŸlemi tamamlandÄ±')}\n**ğŸ‘® Ä°ÅŸlemi Yapan:** {ctx.author.mention}",
        0x00ff00
    )
    success_embed.add_field(
        name="â„¹ï¸ Bilgi", 
        value="KullanÄ±ldÄ±ktan 30 dakika sonra keyler otomatik olarak silinir.", 
        inline=False
    )
    msg = await ctx.send(embed=success_embed)
    
    # Log to console
    print(f"ğŸ§¹ Cleanup performed by {ctx.author}")
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

@bot.command(name='version')
@has_admin_role()
async def update_version(ctx, new_version=None):
    """Version kontrolÃ¼ veya gÃ¼ncelleme"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    if new_version is None:
        # Sadece mevcut version'Ä± gÃ¶ster
        result = make_api_request('version')
        
        if 'error' in result:
            error_embed = create_embed(
                "âŒ Version Kontrol HatasÄ±",
                f"**Hata:** {result['error']}",
                0xff0000
            )
            msg = await ctx.send(embed=error_embed)
            asyncio.create_task(auto_delete_message(msg))
            return
        
        # Current version embed
        version_embed = create_embed(
            "ğŸ“‹ GÃ¼ncel Version",
            f"**ğŸ”¢ Mevcut Version:** `{result.get('version', 'Unknown')}`\n**ğŸ” Talep Eden:** {ctx.author.mention}",
            0x00ff00
        )
        version_embed.add_field(
            name="â„¹ï¸ Bilgi", 
            value="Version gÃ¼ncellemek iÃ§in: `!version <yeni_version>`", 
            inline=False
        )
        msg = await ctx.send(embed=version_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Version gÃ¼ncelleme
    loading_embed = create_embed(
        "ğŸ”„ Version GÃ¼ncelleniyor...",
        f"**ğŸ“ Yeni Version:** `{new_version}`",
        0xffff00
    )
    msg = await ctx.send(embed=loading_embed)
    
    # Update via API
    result = make_api_request('update-version', {'version': new_version})
    
    if 'error' in result:
        error_embed = create_embed(
            "âŒ Version GÃ¼ncelleme HatasÄ±",
            f"**Hata:** {result['error']}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        return
    
    # Success embed
    success_embed = create_embed(
        "âœ… Version GÃ¼ncellendi",
        f"**ğŸ“ Eski Version:** `{result.get('old_version', 'Unknown')}`\n**ğŸ†• Yeni Version:** `{result.get('new_version', new_version)}`\n**ğŸ‘® Ä°ÅŸlemi Yapan:** {ctx.author.mention}",
        0x00ff00
    )
    success_embed.add_field(
        name="â„¹ï¸ Bilgi", 
        value="KullanÄ±cÄ±lar bir sonraki giriÅŸte otomatik gÃ¼ncellenecek!", 
        inline=False
    )
    msg = await ctx.send(embed=success_embed)
    
    # Log to console
    print(f"ğŸ“‹ Version updated by {ctx.author}: {result.get('old_version')} -> {new_version}")
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

@bot.command(name='help')
async def show_help(ctx):
    """Show available commands"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    help_embed = create_embed(
        "ğŸ¯ MIDNIGHT KEYLOGIN BOT",
        "**Komut Rehberi & KullanÄ±m KÄ±lavuzu**\n`< >` = zorunlu parametre â€¢ `[ ]` = opsiyonel parametre",
        0x7289DA
    )
    
    # Ä°ki sÃ¼tunlu layout
    help_embed.add_field(
        name="ğŸ”‘ Key Management",
        value="`!genkey` - Yeni lisans anahtarÄ± oluÅŸtur\n`!keys` - TÃ¼m key'leri listele (ilk 10)\n`!cleanup` - SÃ¼resi dolmuÅŸ key'leri temizle",
        inline=True
    )
    
    help_embed.add_field(
        name="âš¡ Quick Actions",
        value="`!stats` - DetaylÄ± sistem istatistikleri\n`!version [ver]` - Version gÃ¶rÃ¼ntÃ¼le/gÃ¼ncelle\n`!help` - Bu yardÄ±m menÃ¼sÃ¼nÃ¼ gÃ¶ster",
        inline=True
    )
    
    # BoÅŸ alan
    help_embed.add_field(name="\u200b", value="\u200b", inline=False)
    
    help_embed.add_field(
        name="ğŸš« Ban System",
        value="`!ban <kullanÄ±cÄ±> [ip]` - KullanÄ±cÄ± ve IP banla\n`!ban _ <ip>` - Sadece IP banla\n`!unban <kullanÄ±cÄ±> [ip]` - Ban'Ä± kaldÄ±r",
        inline=True
    )
    
    help_embed.add_field(
        name="ğŸ“Š Information",
        value="`!checkban <kullanÄ±cÄ±>` - Ban durumunu kontrol et\n`!banned` - Banli kullanÄ±cÄ±larÄ± listele",
        inline=True
    )
    
    # Footer
    help_embed.set_footer(
        text=f"ğŸ® MIDNIGHT PONYWKA | TÃ¼m mesajlar 6 saniye sonra silinir | {ctx.author.display_name}",
        icon_url=bot.user.avatar.url if bot.user.avatar else None
    )
    
    msg = await ctx.send(embed=help_embed)
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

@bot.event
async def on_command_error(ctx, error):
    """Handle command errors"""
    
    # Delete user's command message
    try:
        await ctx.message.delete()
    except:
        pass
    
    if isinstance(error, commands.CheckFailure):
        error_embed = create_embed(
            "ğŸ”’ Yetki HatasÄ±",
            f"**Bu komutu kullanmak iÃ§in `{ADMIN_ROLE}` rolÃ¼ne sahip olmanÄ±z gerekiyor!**\n\n**ğŸ‘¤ KullanÄ±cÄ±:** {ctx.author.mention}",
            0xff0000
        )
        error_embed.add_field(
            name="ğŸ’¡ Ã‡Ã¶zÃ¼m",
            value="Sunucu yÃ¶neticisinden gerekli rolÃ¼ talep edin.",
            inline=False
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
    
    elif isinstance(error, commands.CommandNotFound):
        error_embed = create_embed(
            "â“ Bilinmeyen Komut",
            f"**GirdiÄŸiniz komut bulunamadÄ±!**\n\n**ğŸ‘¤ KullanÄ±cÄ±:** {ctx.author.mention}",
            0xffaa00
        )
        error_embed.add_field(
            name="ğŸ’¡ YardÄ±m",
            value="`!help` komutunu kullanarak mevcut komutlarÄ± gÃ¶rebilirsiniz.",
            inline=False
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
    
    else:
        error_embed = create_embed(
            "âš ï¸ Sistem HatasÄ±",
            f"**Beklenmeyen bir hata oluÅŸtu!**\n\n**Hata:** `{str(error)}`\n**ğŸ‘¤ KullanÄ±cÄ±:** {ctx.author.mention}",
            0xff0000
        )
        msg = await ctx.send(embed=error_embed)
        asyncio.create_task(auto_delete_message(msg))
        print(f"Command error: {error}")
    
    # Auto delete after 6 seconds
    asyncio.create_task(auto_delete_message(msg))

if __name__ == "__main__":
    print("ğŸš€ Starting Keylogin Management Bot...")
    print("ğŸ“‹ Make sure to configure:")
    print("   â€¢ TOKEN - Your Discord bot token")
    print("   â€¢ GUILD_ID - Your Discord server ID")
    print("   â€¢ API_URL - Your API server URL")
    print("   â€¢ ADMIN_ROLE - Admin role name")
    print("=" * 50)
    
    # Check required environment variables
    missing_vars = []
    if not TOKEN:
        missing_vars.append("TOKEN")
    if not API_URL:
        missing_vars.append("API_URL")
    if not API_TOKEN:
        missing_vars.append("API_TOKEN")
    
    if missing_vars:
        print(f"âŒ Missing required environment variables: {', '.join(missing_vars)}")
        print("ğŸ”§ Please configure these in Railway Dashboard > Variables tab:")
        print(f"   TOKEN = your_discord_bot_token")
        print(f"   API_URL = https://midnightponywka.com/api_optimized.php")
        print(f"   API_TOKEN = MIDNIGHTPONYWKA_SUPER_SECRET_2024_XYZ")
        print(f"   ADMIN_ROLE = Admin")
        exit(1)
    
    try:
        bot.run(TOKEN)
    except Exception as e:
        print(f"âŒ Failed to start bot: {e}") 
